<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.us.mapper.BoardMapper">
	<!-- 목록, 페이징 -->
	<select id="list" resultType="org.us.model.BoardVO">
		select *
		from(
		select @rownum:=@rownum+1 rownum, b.*
		from board b,(select @rownum:=0) as tmp
		<if test="keyword != null">
			<choose>
				<when test="type=='P'.toString()"> <!-- 판매물품명 -->
					where product like concat('%',#{keyword},'%')
				</when>
				<when test="type=='I'.toString()"> <!-- 내용 -->
					where info like concat('%',#{keyword},'%')
				</when>
				<when test="type=='PI'.toString()"> <!-- 판매물품명, 내용 -->
					where product like concat('%',#{keyword},'%')
					or info like concat('%',#{keyword},'%')
				</when>
				<when test="type=='N'.toString()"> <!-- 판매자 -->
					where nick like concat('%',#{keyword},'%')
				</when>
			</choose>
		</if>
		order by bno desc
		) as boardlist
		<![CDATA[
			where rownum > (#{pageNum}-1)*#{amount} and rownum <= #{pageNum}*#{amount}
		]]>
	</select>

	<!-- 거래게시판 전체 개수 -->
	<select id="total" resultType="int">
		select count(*) from board
		<if test="keyword != null">
			<choose>
				<when test="type=='P'.toString()"> <!-- 판매물품명 -->
					where product like concat('%',#{keyword},'%')
				</when>
				<when test="type=='I'.toString()"> <!-- 내용 -->
					where info like concat('%',#{keyword},'%')
				</when>
				<when test="type=='PI'.toString()"> <!-- 판매물품명, 내용 -->
					where product like concat('%',#{keyword},'%')
					or info like concat('%',#{keyword},'%')
				</when>
				<when test="type=='N'.toString()"> <!-- 판매자 -->
					where nick like concat('%',#{keyword},'%')
				</when>
			</choose>
		</if>
	</select>

	<!-- 조회수 -->
	<update id="cntup">
		update board
		set cnt = cnt + 1
		where bno = #{bno}
	</update>

	<!-- 디테일 -->
	<select id="detail" resultType="org.us.model.BoardVO">
		select * from board
		where bno = #{bno}
	</select>

	<!-- 글 작성 -->
	<insert id="write">
		<selectKey keyProperty="bno" order="BEFORE" resultType="int">
			select
			case
			when bno is null then 1
			else max(bno)+1
			end bno
			from board
		</selectKey>
		insert into board(id, nick, title, content, category, price,cnt)
		values(#{id},#{nick},#{title},#{content},#{category},#{price},0)
	</insert>
</mapper>